import os
from snakemake.utils import min_version

min_version("7.32.4")

configfile: "config/config.yml"

### helper functions

def revComplementary(seq):
    """ Returns the reverse complementary of a DNA sequence
        All IUPAC codes included
    """
    trans_dict = {"A":"T","C":"G","G":"C","T":"A",
                  "N":"N","R":"Y","Y":"R","S":"S",
                  "W":"W","K":"M","M":"K","B":"V",
                  "V":"B","D":"H","H":"D"}
    return "".join([trans_dict[nt] for nt in seq[::-1]])

def pathCreator(dir):
    """ Return a lambda function that joins paths with the specified dir
        Useful for not repeating paths all the time in rules
    """
    return lambda *args: os.path.join(dir, *args)

### create log dirs

logdirs = ["default",
          "all",
          "fastqc_before",
          "cutadapt",
          "fastqc_after",
          "multiqc",
          "create_manifest",
          "import_fastq",
          "itsxpress",
          "dada2",
          "taxonomy",
          "diversity"]

for d in logdirs:
    os.makedirs(os.path.join("logs", d), exist_ok = True)

## directory variables and functions

proj_dir = os.path.join(config["outdir"], config["proj_name"])

fastqc_before_dir = pathCreator(os.path.join(proj_dir, "fastqc_before"))
cutadapt_dir = pathCreator(os.path.join(proj_dir, "reads_trimmed"))
cutadapt_logdir = pathCreator(os.path.join(proj_dir, "cutadapt_logs"))
fastqc_after_dir = pathCreator(os.path.join(proj_dir, "fastqc_after"))
multiqc_dir = pathCreator(os.path.join(proj_dir, "multiqc"))
qiime2_dir = pathCreator(os.path.join(proj_dir, "qiime2"))

## conda environment variables

code_dir = os.path.abspath(os.getcwd())
conda_env_dir = os.path.join(code_dir, "workflow", "envs")
conda_qc = os.path.join(conda_env_dir, "qc.yml")
conda_qiime2 = os.path.join(conda_env_dir, "qiime2-amplicon-2024.2-py38-linux-conda.yml")

## create outdir

os.makedirs(proj_dir, exist_ok = True)

## sample names

SAMPLES = list(set([s[:-len("_RX.fastq.gz")] for s in os.listdir(config["raw_data"])]))

## optional itsxpress rule handling

if config["use_itsxpress"] == True:
  dada2_input_seqs_qza = qiime2_dir("itsxpress", "its_seqs.qza")
else:
  dada2_input_seqs_qza = qiime2_dir("reads", "demux.qza")

## output handling

alloutput = list()
alloutput.append(multiqc_dir("multiqc_report.html"))
alloutput.append(qiime2_dir("taxonomy", "taxonomy.qza"))
alloutput.append(qiime2_dir("taxonomy", "taxonomy.qzv"))
alloutput.append(qiime2_dir("taxonomy", "barplot.qzv"))
alloutput.append(qiime2_dir("dada2", "sp_collapsed_table.qza"))
alloutput.append(qiime2_dir("dada2", "sp_collapsed_table.qzv"))
alloutput.append(qiime2_dir("diversity", "rarefaction_curves.qzv"))
alloutput.append(qiime2_dir("diversity", "rarefied_table.qza"))
alloutput.append(qiime2_dir("diversity", "observed_features_vector.qza"))
alloutput.append(qiime2_dir("diversity", "shannon_vector.qza"))
alloutput.append(qiime2_dir("diversity", "evenness_vector.qza"))
alloutput.append(qiime2_dir("diversity", "jaccard_distance_matrix.qza"))
alloutput.append(qiime2_dir("diversity", "bray_curtis_distance_matrix.qza"))
alloutput.append(qiime2_dir("diversity", "jaccard_pcoa_results.qza"))
alloutput.append(qiime2_dir("diversity", "bray_curtis_pcoa_results.qza"))
alloutput.append(qiime2_dir("diversity", "jaccard_emperor.qzv"))
alloutput.append(qiime2_dir("diversity", "bray_curtis_emperor.qzv"))


rule all:
    input:
        alloutput

### load rules

include: "rules/fastqc_before.smk"
include: "rules/cutadapt.smk"
include: "rules/fastqc_after.smk"
include: "rules/multiqc.smk"
include: "rules/create_manifest.smk"
include: "rules/import_fastq.smk"
include: "rules/itsxpress.smk"
include: "rules/dada2.smk"
include: "rules/taxonomy.smk"
include: "rules/diversity.smk"